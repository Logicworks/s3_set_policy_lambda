#Make sure you set the following environment variables
# code-bucket          ==> What is the s3 bucket you want to store the 3 bucket in
# AWS_SCRT_KEY         ==> Your aws Secret Key ID
# AWS_SRCT_ACCESS_KEY  ==> Your aws secret key
# AWS_TERRAFORM_ROLE   ==> What role do you want to assume.

version: 2.1

orbs:
  aws-cli: circleci/aws-cli@0.1.13
  aws-assume-role: holdaraffle/aws-assume-role@0.0.10

jobs:
  set-aws-creds:
    executor: aws-cli/default
    steps:
      - aws-cli/install
      - aws-assume-role/assume_role:
          access_key_id: AWS_SCRT_KEY
          secret_access_key: AWS_SRCT_ACCESS_KEY
          account: ${AWS_SS_ACCOUNT_ID}
          role: ${AWS_TERRAFORM_ROLE}
      - run:
          name: "Show AWS Creds file"
          command: |
               aws configure set region us-east-1 --profile default
               cat ~/.aws/credentials
      - save_cache:
          key: policy-cache-v1-{{ .Revision }}
          paths:
            - ~/.aws
  build-lambda-function:
    docker:
      - image: circleci/python:3.6.8
    steps:
      - checkout
      - aws-cli/install
      - restore_cache:
          keys:
            - policy-cache-v1-{{ .Revision }}
      - run:
          name: install sam cli
          command: |
            pip install --user aws-sam-cli
      - run:
          name: Issue Sam Build
          command: |
            ~/.local/bin/sam build
      - run:
          name: Sam Package
          command: |
             ~/.local/bin/sam package --output-template-file packaged.yaml --s3-bucket ${code_bucket}
      - run:
          name: Sam Deploy
          command: |
            aws cloudformation deploy --template-file ~/project/packaged.yaml  --stack-name setpolicylambda --capabilities CAPABILITY_IAM
workflows:
  version: 2.1
  build-deploy:
    jobs:
      - set-aws-creds
      - build-lambda-function:
          requires:
            - set-aws-creds